# chatgpt-on-wechat äºŒæ¬¡å¼€å‘å®Œæ•´æŒ‡å—

## ğŸ” é¡¹ç›®æ¶æ„è§£æ

### æ ¸å¿ƒæ–‡ä»¶ç»“æ„
```
chatgpt-on-wechat/
â”œâ”€â”€ app.py                    # ğŸš€ ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ config.py                 # âš™ï¸ é…ç½®ç®¡ç†
â”œâ”€â”€ bridge/                   # ğŸŒ‰ æ¶ˆæ¯æ¡¥æ¥å±‚
â”‚   â”œâ”€â”€ bridge.py            # æ ¸å¿ƒæ¡¥æ¥é€»è¾‘
â”‚   â”œâ”€â”€ context.py           # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â””â”€â”€ reply.py             # å›å¤æ¶ˆæ¯å¤„ç†
â”œâ”€â”€ channel/                  # ğŸ“± é€šé“å±‚ï¼ˆå„å¹³å°æ¥å…¥ï¼‰
â”‚   â”œâ”€â”€ wechatmp/            # å¾®ä¿¡å…¬ä¼—å·
â”‚   â”œâ”€â”€ dingtalk/            # é’‰é’‰
â”‚   â”œâ”€â”€ web/                 # ç½‘é¡µç‰ˆ
â”‚   â””â”€â”€ ...
â”œâ”€â”€ bot/                     # ğŸ¤– AIæ¨¡å‹å±‚
â”‚   â”œâ”€â”€ openai/              # OpenAIæ¥å…¥
â”‚   â”œâ”€â”€ claude/              # Claudeæ¥å…¥
â”‚   â””â”€â”€ ...
â”œâ”€â”€ plugins/                 # ğŸ”Œ æ’ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ plugin_manager.py    # æ’ä»¶ç®¡ç†å™¨
â”‚   â””â”€â”€ plugin.py            # æ’ä»¶åŸºç±»
â””â”€â”€ voice/                   # ğŸµ è¯­éŸ³å¤„ç†
```

### æ ¸å¿ƒè®¾è®¡æ¨¡å¼
1. **æ¡¥æ¥æ¨¡å¼**: bridgeå±‚è§£è€¦æ¶ˆæ¯æ¥æ”¶å’ŒAIå¤„ç†
2. **ç­–ç•¥æ¨¡å¼**: ä¸åŒAIæ¨¡å‹ã€ä¸åŒé€šé“çš„å®ç°
3. **æ’ä»¶æ¨¡å¼**: å¯æ‰©å±•çš„åŠŸèƒ½æ¨¡å—
4. **å·¥å‚æ¨¡å¼**: åŠ¨æ€åˆ›å»ºå„ç§å®ä¾‹

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒæ­å»º

### 1. Forké¡¹ç›®å¹¶åˆ›å»ºå¼€å‘åˆ†æ”¯
```bash
# ForkåŸé¡¹ç›®åˆ°ä½ çš„GitHubè´¦å·
# ç„¶åå…‹éš†ä½ çš„Fork
git clone https://github.com/ä½ çš„ç”¨æˆ·å/chatgpt-on-wechat.git
cd chatgpt-on-wechat

# åˆ›å»ºå¼€å‘åˆ†æ”¯
git checkout -b dev-your-feature
```

### 2. æœ¬åœ°å¼€å‘ç¯å¢ƒ
```bash
# åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
pip install -r requirements-optional.txt

# å®‰è£…å¼€å‘ä¾èµ–
pip install black pytest flake8 mypy
```

### 3. å¼€å‘é…ç½®
```bash
# å¤åˆ¶é…ç½®æ¨¡æ¿
cp config-template.json config-dev.json

# ç¼–è¾‘å¼€å‘é…ç½®
nano config-dev.json
```

## ğŸ¯ äºŒæ¬¡å¼€å‘æœ€ä½³å®è·µ

### 1. æ–°å¢AIæ¨¡å‹æ¥å…¥

**æ­¥éª¤**ï¼š
1. åœ¨ `bot/` ç›®å½•ä¸‹åˆ›å»ºæ–°æ¨¡å‹æ–‡ä»¶å¤¹
2. ç»§æ‰¿ `Bot` åŸºç±»
3. å®ç°å¿…è¦çš„æ¥å£æ–¹æ³•

**ç¤ºä¾‹ï¼šæ¥å…¥æ™ºè°±AI**
```python
# bot/zhipu/zhipu_bot.py
from bot.bot import Bot
from bridge.context import ContextType
from bridge.reply import Reply, ReplyType
from common.log import logger
import requests

class ZhipuBot(Bot):
    def __init__(self):
        super().__init__()
        self.api_key = conf().get("zhipu_ai_api_key")
        self.api_base = conf().get("zhipu_ai_api_base")
        
    def reply(self, query, context=None):
        try:
            # è°ƒç”¨æ™ºè°±AI API
            response = self._call_zhipu_api(query)
            return Reply(ReplyType.TEXT, response)
        except Exception as e:
            logger.error(f"ZhipuBot reply error: {e}")
            return Reply(ReplyType.ERROR, "æ™ºè°±AIè°ƒç”¨å¤±è´¥")
    
    def _call_zhipu_api(self, query):
        # å®ç°å…·ä½“çš„APIè°ƒç”¨é€»è¾‘
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        data = {
            "model": "glm-4",
            "messages": [{"role": "user", "content": query}]
        }
        response = requests.post(
            f"{self.api_base}/chat/completions",
            headers=headers,
            json=data
        )
        return response.json()["choices"][0]["message"]["content"]
```

### 2. æ–°å¢æ¶ˆæ¯é€šé“

**æ­¥éª¤**ï¼š
1. åœ¨ `channel/` ç›®å½•ä¸‹åˆ›å»ºæ–°é€šé“æ–‡ä»¶å¤¹
2. ç»§æ‰¿ `ChatChannel` åŸºç±»
3. å®ç°æ¶ˆæ¯æ¥æ”¶å’Œå‘é€é€»è¾‘

**ç¤ºä¾‹ï¼šæ¥å…¥Telegram**
```python
# channel/telegram/telegram_channel.py
from channel.chat_channel import ChatChannel
from bridge.context import Context, ContextType
from bridge.reply import Reply, ReplyType
from common.log import logger
import telegram

class TelegramChannel(ChatChannel):
    def __init__(self):
        super().__init__()
        self.bot_token = conf().get("telegram_bot_token")
        self.bot = telegram.Bot(token=self.bot_token)
        
    def startup(self):
        logger.info("Starting Telegram channel...")
        # å¯åŠ¨Telegramæ¶ˆæ¯æ¥æ”¶é€»è¾‘
        
    def handle_text(self, message):
        # å¤„ç†æ–‡æœ¬æ¶ˆæ¯
        context = Context(ContextType.TEXT, message.text)
        context['session_id'] = message.chat_id
        context['msg'] = message
        self.produce(context)
        
    def send(self, reply: Reply, context: Context):
        # å‘é€å›å¤æ¶ˆæ¯
        chat_id = context['session_id']
        if reply.type == ReplyType.TEXT:
            self.bot.send_message(chat_id=chat_id, text=reply.content)
```

### 3. å¼€å‘è‡ªå®šä¹‰æ’ä»¶

**æ­¥éª¤**ï¼š
1. åœ¨ `plugins/` ç›®å½•ä¸‹åˆ›å»ºæ’ä»¶æ–‡ä»¶å¤¹
2. ç»§æ‰¿ `Plugin` åŸºç±»
3. æ³¨å†Œäº‹ä»¶å¤„ç†å™¨

**ç¤ºä¾‹ï¼šå¤©æ°”æŸ¥è¯¢æ’ä»¶**
```python
# plugins/weather/weather.py
import plugins
from plugins import *
from bridge.context import ContextType
from bridge.reply import Reply, ReplyType
import requests

@plugins.register(
    name="weather",
    desc="å¤©æ°”æŸ¥è¯¢æ’ä»¶",
    version="1.0",
    author="ä½ çš„åå­—",
    desire_priority=100
)
class WeatherPlugin(Plugin):
    def __init__(self):
        super().__init__()
        self.handlers[Event.ON_HANDLE_CONTEXT] = self.on_handle_context
        self.config = self.load_config()
        logger.info("[Weather] å¤©æ°”æ’ä»¶å·²åŠ è½½")
    
    def on_handle_context(self, e_context: EventContext):
        if e_context['context'].type != ContextType.TEXT:
            return
            
        content = e_context['context'].content.strip()
        if content.startswith("å¤©æ°”"):
            city = content.replace("å¤©æ°”", "").strip()
            if city:
                weather_info = self.get_weather(city)
                reply = Reply(ReplyType.TEXT, weather_info)
                e_context['reply'] = reply
                e_context.action = EventAction.BREAK_PASS
    
    def get_weather(self, city):
        try:
            # è°ƒç”¨å¤©æ°”API
            api_key = self.config.get("weather_api_key")
            url = f"http://api.weatherapi.com/v1/current.json?key={api_key}&q={city}"
            response = requests.get(url)
            data = response.json()
            
            location = data['location']['name']
            temp = data['current']['temp_c']
            condition = data['current']['condition']['text']
            
            return f"{location}å½“å‰å¤©æ°”ï¼š{condition}ï¼Œæ¸©åº¦{temp}Â°C"
        except Exception as e:
            logger.error(f"è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥: {e}")
            return "æŠ±æ­‰ï¼Œæ— æ³•è·å–å¤©æ°”ä¿¡æ¯"
    
    def get_help_text(self, **kwargs):
        return "å‘é€ 'å¤©æ°” åŸå¸‚å' æŸ¥è¯¢å¤©æ°”ä¿¡æ¯"
```

### 4. è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†é€»è¾‘

**ä¿®æ”¹æ¡¥æ¥å±‚é€»è¾‘**ï¼š
```python
# åœ¨ bridge/bridge.py ä¸­æ·»åŠ è‡ªå®šä¹‰å¤„ç†
class Bridge:
    def fetch_reply_content(self, query, context):
        # åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰çš„é¢„å¤„ç†é€»è¾‘
        query = self.preprocess_query(query, context)
        
        # è°ƒç”¨åŸæœ‰é€»è¾‘
        reply = self.bot.reply(query, context)
        
        # åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰çš„åå¤„ç†é€»è¾‘
        reply = self.postprocess_reply(reply, context)
        return reply
    
    def preprocess_query(self, query, context):
        # è‡ªå®šä¹‰æŸ¥è¯¢é¢„å¤„ç†
        # ä¾‹å¦‚ï¼šæ•æ„Ÿè¯è¿‡æ»¤ã€æ ¼å¼åŒ–ç­‰
        return query
    
    def postprocess_reply(self, reply, context):
        # è‡ªå®šä¹‰å›å¤åå¤„ç†
        # ä¾‹å¦‚ï¼šæ·»åŠ ç­¾åã€æ ¼å¼åŒ–ç­‰
        return reply
```

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•

### 1. å•å…ƒæµ‹è¯•
```python
# tests/test_weather.py
import unittest
from plugins.weather.weather import WeatherPlugin

class TestWeatherPlugin(unittest.TestCase):
    def setUp(self):
        self.plugin = WeatherPlugin()
    
    def test_get_weather(self):
        result = self.plugin.get_weather("åŒ—äº¬")
        self.assertIn("å¤©æ°”", result)
```

### 2. è°ƒè¯•æŠ€å·§
```python
# åœ¨ä»£ç ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—
logger.debug(f"å¤„ç†æ¶ˆæ¯: {content}")
logger.info(f"è°ƒç”¨API: {api_url}")
logger.error(f"é”™è¯¯ä¿¡æ¯: {error}")

# ä½¿ç”¨æ–­ç‚¹è°ƒè¯•
import pdb; pdb.set_trace()
```

### 3. é…ç½®å¼€å‘æ¨¡å¼
```json
// config-dev.json
{
  "debug": true,
  "channel_type": "web",  // ä½¿ç”¨webæ¨¡å¼ä¾¿äºè°ƒè¯•
  "hot_reload": true      // å¼€å¯çƒ­é‡è½½
}
```

## ğŸ“¦ éƒ¨ç½²å’Œå‘å¸ƒ

### 1. ç‰ˆæœ¬ç®¡ç†
```bash
# æäº¤ä»£ç 
git add .
git commit -m "feat: æ·»åŠ å¤©æ°”æŸ¥è¯¢æ’ä»¶"
git push origin dev-your-feature

# åˆ›å»ºPull Requeståˆ°åŸé¡¹ç›®
```

### 2. æ‰“åŒ…å‘å¸ƒ
```bash
# åˆ›å»ºå‘å¸ƒåŒ…
python setup.py sdist bdist_wheel

# æˆ–è€…ä½¿ç”¨Docker
docker build -t my-chatgpt-wechat .
```

### 3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```bash
# ä½¿ç”¨ä½ ä¹‹å‰çš„éƒ¨ç½²è„šæœ¬
bash deploy.sh

# æˆ–è€…ä½¿ç”¨Docker Compose
docker-compose up -d
```

## ğŸ¯ è¿›é˜¶å¼€å‘å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨å¼‚æ­¥å¤„ç†æé«˜å¹¶å‘æ€§èƒ½
- æ·»åŠ ç¼“å­˜å‡å°‘é‡å¤APIè°ƒç”¨
- å®ç°è¿æ¥æ± ç®¡ç†

### 2. å®‰å…¨åŠ å›º
- APIå¯†é’¥åŠ å¯†å­˜å‚¨
- è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
- è®¿é—®æƒé™æ§åˆ¶

### 3. ç›‘æ§å’Œæ—¥å¿—
- æ·»åŠ æ€§èƒ½ç›‘æ§æŒ‡æ ‡
- ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- é”™è¯¯æŠ¥è­¦æœºåˆ¶

### 4. æ‰©å±•æ€§è®¾è®¡
- ä½¿ç”¨ä¾èµ–æ³¨å…¥
- äº‹ä»¶é©±åŠ¨æ¶æ„
- å¾®æœåŠ¡æ‹†åˆ†

## ğŸ”§ å¸¸ç”¨å¼€å‘å‘½ä»¤

```bash
# ä»£ç æ ¼å¼åŒ–
black . --line-length 120

# ç±»å‹æ£€æŸ¥
mypy .

# è¿è¡Œæµ‹è¯•
pytest tests/

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
python app.py --cmd

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/app.log
```

## ğŸ“š å­¦ä¹ èµ„æº

1. **å®˜æ–¹æ–‡æ¡£**: https://github.com/zhayujie/chatgpt-on-wechat
2. **æ’ä»¶å¼€å‘**: å‚è€ƒå·²æœ‰æ’ä»¶çš„å®ç°
3. **APIæ–‡æ¡£**: å„AIå¹³å°çš„å®˜æ–¹APIæ–‡æ¡£
4. **ç¤¾åŒºè®¨è®º**: GitHub Issues å’Œ Discussions

---

ğŸ’¡ **å°è´´å£«**: å»ºè®®ä»å°åŠŸèƒ½å¼€å§‹ï¼Œé€æ­¥ç†Ÿæ‚‰ä»£ç ç»“æ„ï¼Œç„¶åå†è¿›è¡Œå¤§çš„æ”¹åŠ¨ã€‚ 